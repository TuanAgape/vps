name: Multi Ubuntu VPS (tmate)

on:
  workflow_dispatch:
    inputs:
      count:
        description: "Sá»‘ VPS muá»‘n táº¡o (1â€“10)"
        required: true
        default: "10"
      stagger_seconds:
        description: "GiÃ£n thá»i gian khá»Ÿi Ä‘á»™ng giá»¯a cÃ¡c VPS (giÃ¢y)"
        required: true
        default: "5"

jobs:
  vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    strategy:
      fail-fast: false
      max-parallel: 2              # ðŸ‘ˆ phÃ¹ há»£p giá»›i háº¡n repo private/free
      matrix:
        idx: [1,2,3,4,5,6,7,8,9,10]
    steps:
      - name: Gate theo sá»‘ lÆ°á»£ng yÃªu cáº§u
        id: gate
        run: |
          REQ=${{ inputs.count }}
          IDX=${{ matrix.idx }}
          if [ "$IDX" -le "$REQ" ]; then
            echo "run_this=true" >> $GITHUB_OUTPUT
          else
            echo "run_this=false" >> $GITHUB_OUTPUT
          fi

      - name: Chá» theo chá»‰ sá»‘ (stagger)
        if: steps.gate.outputs.run_this == 'true'
        run: |
          S=${{ inputs.stagger_seconds }}
          [ -z "$S" ] && S=5
          sleep $(( ( ${{ matrix.idx }} - 1 ) * S ))

      - name: In thÃ´ng tin runner
        if: steps.gate.outputs.run_this == 'true'
        run: |
          echo "VPS #${{ matrix.idx }}"
          uname -a
          command -v lsb_release >/dev/null && lsb_release -a || true
          echo -n "IP public: "
          curl -s ifconfig.me || true
          echo
          echo "Má»—i VPS tá»‘i Ä‘a ~6h."

      - name: Start SSH session (tmate) - VPS #${{ matrix.idx }}
        if: steps.gate.outputs.run_this == 'true'
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: false
